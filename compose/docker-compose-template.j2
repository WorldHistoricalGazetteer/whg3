networks:
  {{ ENV_CONTEXT }}:
    driver: bridge
    ipam:
      config:
        - subnet: {{ SUBNET }}
  {{ VESPA_NETWORK }}:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16

volumes:
  vespa_data:
  shared-tmp:
{% if ENV_CONTEXT == 'local' %}
  app:
  dev-db-data:
{% endif %}

services:

  web:
    networks:
      - {{ ENV_CONTEXT }}
      - {{ VESPA_NETWORK }}
    platform: linux/amd64
    image: {{ DOCKER_IMAGE }}:{{ DOCKER_IMAGE_TAG }}
    container_name: web_{{ ENV_CONTEXT }}_{{ BRANCH }}
    volumes:
      - {{ BASE_DIR }}:/app
      - {{ BASE_DIR }}/entrypoints/entrypoint-web.sh:/entrypoint.sh
      - shared-tmp:/var/tmp
      - /run/docker.sock:/var/run/docker.sock  # Mount Docker socket
      - ~/.docker:/root/.docker  # Mount Docker config for auth, etc.
    {% if not ENV_CONTEXT == 'local' %}
      - /home/whgadmin/sites/logs/{{ ENV_CONTEXT }}:/app/whg/logs
      - /home/whgadmin/sites/data_dumps:/app/data_dumps
    {% endif %}
    env_file: {{ BASE_DIR }}/.env/.env
    environment:
      - DJANGO_SETTINGS_MODULE=whg.settings
      - PYTHONPATH=/app/index/cli/bin:${PYTHONPATH}
    ports:
      - "{{ APP_PORT }}:{{ APP_PORT }}"
    user: "1000:1000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "{{ VESPA_CONFIG_HOSTNAME }}:{{ VESPA_CONFIG_IP }}"
      - "{{ VESPA_SERVICE_HOSTNAME }}:{{ VESPA_SERVICE_IP }}"
    depends_on:
      - redis
      - {{ DB_HOST }}
{% if ENV_CONTEXT != 'whgazetteer.org' %}
      - webpack
{% endif %}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{ APP_PORT }}/health"]
      interval: 60s
      retries: 5
      start_period: 60s
      timeout: 15s

{% if ENV_CONTEXT != 'whgazetteer.org' %}
  webpack:
    networks:
      - {{ ENV_CONTEXT }}
    platform: linux/amd64
    image: node:18
    container_name: webpack_{{ ENV_CONTEXT }}_{{ BRANCH }}
    logging:
      driver: local
    volumes:
      - {{ BASE_DIR }}:/app
    entrypoint: ["/app/entrypoints/entrypoint-webpack.sh"]
    restart: unless-stopped
{% endif %}

  {{ DB_HOST }}:
    networks:
      - {{ ENV_CONTEXT }}
    platform: linux/amd64
    image: postgis/postgis:15-3.4
    container_name: postgres_{{ ENV_CONTEXT }}_{{ BRANCH }}
    ports:
      - "127.0.0.1:{{ DB_PORT }}:{{ DB_PORT_INTERNAL }}"
    volumes:
    {% if ENV_CONTEXT == 'local' %}
      - dev-db-data:/var/lib/postgresql/data
      - {{ BASE_DIR }}/entrypoints/entrypoint-postgres-local.sh:/docker-entrypoint-initdb.d/10_postgis.sh
      - {{ BASE_DIR }}/data:/app/data
    {% else %}
      - /home/whgadmin/databases/{{ ENV_CONTEXT }}:/var/lib/postgresql/data
      - {{ BASE_DIR }}/server-admin/restore_db_from_dump.sh:/tmp/restore_db_from_dump.sh
    {% endif %}
      - {{ BASE_DIR }}/compose/pg_hba.conf:/etc/postgresql/pg_hba.conf
    env_file: {{ BASE_DIR }}/.env/.env
    command: ["postgres", "-c", "hba_file=/etc/postgresql/pg_hba.conf"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 60s
      retries: 5
      start_period: 60s
      timeout: 15s

  redis:
    networks:
      - {{ ENV_CONTEXT }}
    platform: linux/amd64
    image: redis:bullseye
    container_name: redis_{{ ENV_CONTEXT }}_{{ BRANCH }}
    ports:
      - "{{ REDIS_PORT }}:6379"
    {% if not ENV_CONTEXT == 'local' %}
    volumes:
      - /home/whgadmin/sites/logs/{{ ENV_CONTEXT }}:/app/whg/logs
    {% endif %}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 60s
      retries: 5
      start_period: 60s
      timeout: 15s

  celery_worker:
    networks:
      - {{ ENV_CONTEXT }}
    image: {{ DOCKER_IMAGE }}:{{ DOCKER_IMAGE_TAG }}
    container_name: celery-worker_{{ ENV_CONTEXT }}_{{ BRANCH }}
    hostname: celery_worker
    volumes:
      - {{ BASE_DIR }}:/app
      - {{ BASE_DIR }}/entrypoints/entrypoint-celery.sh:/entrypoint.sh
      - shared-tmp:/var/tmp
    {% if ENV_CONTEXT == 'local' %}
      - /etc/docker/certs:/certs
    {% else %}
      - /home/whgadmin/sites/logs/{{ ENV_CONTEXT }}:/app/whg/logs
      - /home/whgadmin/sites/data_dumps:/app/data_dumps
      - /home/whgadmin/docker-certs/ca/ca.pem:/certs/ca.pem:ro
      - /home/whgadmin/docker-certs/client/client-cert.pem:/certs/client-cert.pem:ro
      - /home/whgadmin/docker-certs/client/client-key.pem:/certs/client-key.pem:ro
    {% endif %}
      - /var/run/docker.sock:/var/run/docker.sock:ro
    env_file: {{ BASE_DIR }}/.env/.env
    environment:
      - DJANGO_SETTINGS_MODULE=whg.settings
      - DOCKER_HOST=tcp://{{ DOCKER_HOST_IP }}
      - DOCKER_TLS_VERIFY=1
      - DOCKER_CERT_PATH=/certs
    depends_on:
      - redis
      - {{ DB_HOST }}
    restart: unless-stopped

  celery_beat:
    networks:
      - {{ ENV_CONTEXT }}
    image: {{ DOCKER_IMAGE }}:{{ DOCKER_IMAGE_TAG }}
    container_name: celery-beat_{{ ENV_CONTEXT }}_{{ BRANCH }}
    volumes:
      - {{ BASE_DIR }}:/app
      - {{ BASE_DIR }}/entrypoints/entrypoint-celery-beat.sh:/entrypoint.sh
    {% if not ENV_CONTEXT == 'local' %}
      - /home/whgadmin/sites/logs/{{ ENV_CONTEXT }}:/app/whg/logs
      - /home/whgadmin/sites/data_dumps:/app/data_dumps
    {% endif %}
    env_file: {{ BASE_DIR }}/.env/.env
    environment:
      - DJANGO_SETTINGS_MODULE=whg.settings
    depends_on:
      - redis
      - {{ DB_HOST }}
    restart: unless-stopped

  {{ VESPA_CONFIG_HOSTNAME }}:
    image: {{ VESPA_IMAGE }}
    container_name: {{ VESPA_CONFIG_HOSTNAME }}
    hostname: {{ VESPA_CONFIG_HOSTNAME }}
    privileged: true
    environment:
      - VESPA_CONFIGSERVERS={{ VESPA_CONFIG_IP }}
      - VESPA_HOSTNAME={{ VESPA_CONFIG_IP }}
    ports:
      - "{{ VESPA_CONFIG_PORT }}:19071"
      - "{{ VESPA_CONFIG_SERVICE_PORT }}:8080"
    networks:
      {{ VESPA_NETWORK }}:
        ipv4_address: {{ VESPA_CONFIG_IP }}
    volumes:
      - vespa_data:/opt/vespa/var
    command: configserver

  {{ VESPA_SERVICE_HOSTNAME }}:
    image: {{ VESPA_IMAGE }}
    container_name: {{ VESPA_SERVICE_HOSTNAME }}
    hostname: {{ VESPA_SERVICE_HOSTNAME }}
    privileged: true
    environment:
      - VESPA_CONFIGSERVERS={{ VESPA_CONFIG_IP }}
      - VESPA_HOSTNAME={{ VESPA_SERVICE_IP }}
    ports:
      - "{{ VESPA_SERVICE_PORT }}:8080"
    networks:
      {{ VESPA_NETWORK }}:
        ipv4_address: {{ VESPA_SERVICE_IP }}
    volumes:
      - vespa_data:/opt/vespa/var
    command: services
    
